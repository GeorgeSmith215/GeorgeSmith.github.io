<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="前端工程化之自动化构建, 智升的博客">
    <meta name="description" content="高山仰止，景行行止。虽不能至，然心向往之。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=283945685"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', '283945685');
</script>


    <title>前端工程化之自动化构建 | 智升的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="智升的博客" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">智升的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">智升的博客</div>
        <div class="logo-desc">
            
            高山仰止，景行行止。虽不能至，然心向往之。
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/georgesmith215" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/georgesmith215" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/1.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">前端工程化之自动化构建</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/study/">
                                <span class="chip bg-color">study</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%AD%A6%E4%B9%A0/" class="post-category">
                                学习
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-06-12
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2022-06-12
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    18.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    74 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前端工程化之自动化构建–Gulp案例与封装、FIS使用"><a href="#前端工程化之自动化构建–Gulp案例与封装、FIS使用" class="headerlink" title="前端工程化之自动化构建–Gulp案例与封装、FIS使用"></a>前端工程化之自动化构建–Gulp案例与封装、FIS使用</h1><h4 id="相关文件下载：传送门"><a href="#相关文件下载：传送门" class="headerlink" title="相关文件下载：传送门"></a>相关文件下载：<a target="_blank" rel="noopener" href="https://github.com/GeorgeSmith215/study-materials/tree/main/pages-boilerplate">传送门</a></h4><h3 id="1、gulp案例-样式编译"><a href="#1、gulp案例-样式编译" class="headerlink" title="1、gulp案例-样式编译"></a>1、gulp案例-样式编译</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// gulpfile.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token comment">// 先执行 `yarn add gulp-sass --dev` 去安装gulp—sass插件</span>
<span class="token comment">// 再执行 `yarn add sass --dev` 去安装sass解释器</span>
<span class="token comment">// 另外下载时可能会失败，可以通过淘宝镜像源为sass配置镜像</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用base选项去指定基准路径，输出到dist目录后也能保留src下的目录结构</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/style/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//基本上每一个插件提供的都是一个函数，而函数的调用结果则会返回一个文件的转换流</span>
    <span class="token comment">//注意sass模块工作时会认为"_"下划线开头的样式文件都是主文件依赖的文件而不去转换</span>
    <span class="token comment">//而outputStyle: 'expanded'是为了设置css结束的括弧“}”到新的一行而不是末尾</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    style
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="2、gulp案例-脚本编译"><a href="#2、gulp案例-脚本编译" class="headerlink" title="2、gulp案例-脚本编译"></a>2、gulp案例-脚本编译</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// gulpfile.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 需要先执行`yarn add gulp-babel --dev`去添加gulp-babel到开发依赖中</span>
<span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-babel'</span><span class="token punctuation">)</span>

<span class="token comment">// 样式编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/style/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//gulp-babel只是去唤醒babel-core模块中的转换过程，</span>
    <span class="token comment">//所以还需要先执行`yarn add @babel/core '@babel/preset-env' --dev`安装需要的模块。</span>
    <span class="token comment">//其中'@babel/preset-env'模块可以把ES的全部新特性都进行转换</span>
    <span class="token comment">//注意如果在babel中忘了传presets的话，则会出现转换没有效果的情况出现，</span>
    <span class="token comment">//因为babel只是一个ES的转换平台，实际上具体做转换的是babel里的一些插件，</span>
    <span class="token comment">//而'@babel/preset-env'就是插件的集合，是最新es所有整体特性的打包。</span>
    <span class="token comment">//当然我们也可以根据需要去安装对应的babel转换插件，然后在presets里传入对应插件即可</span>
    <span class="token comment">//在dest之前先pipe到babel插件中</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    style<span class="token punctuation">,</span>
    script<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>另外我们对babel的配置也可以单独添加一个babelrc文件，我们上面只是写在了代码里，实际上功能上没有什么区别。</p>
<h3 id="3、gulp案例-页面模板编译及任务组合"><a href="#3、gulp案例-页面模板编译及任务组合" class="headerlink" title="3、gulp案例-页面模板编译及任务组合"></a>3、gulp案例-页面模板编译及任务组合</h3><p>模板文件实际上就是html文件，我们可以用模板引擎去把页面中重用的部分抽象出来，这里我们使用swig模板引擎。通过执行<code>yarn add gulp-swig --dev</code>把gulp-swig加入开发依赖。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// gulpfile.js</span>
<span class="token comment">// 因样式，脚本，页面可以同时编译故可通过parallel组合任务</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> parallel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-babel'</span><span class="token punctuation">)</span>
<span class="token comment">// 执行`yarn add gulp-swig --dev`安装gulp-swig后引入对应插件</span>
<span class="token keyword">const</span> swig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-swig'</span><span class="token punctuation">)</span>

<span class="token comment">// 样式编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/style/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 脚本编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 提供给模板使用的数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  menus<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
      icon<span class="token operator">:</span> <span class="token string">'aperture'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'index.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Features'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'features.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'about.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Contact'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'#'</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://dipcheese.com'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'divider'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://github.com/GeorgeSmith215'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  pkg<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  date<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//注意若我们需要选择src目录及其子目录下的所有HTML文件的话可以使用'src/**/*.html'</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//在swig中指定data参数并传入相关的数据供模板的数据标记使用</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 通过parallel组合三个任务使其可以同时执行</span>
<span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    compile<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="4、gulp案例-图片和字体文件转换"><a href="#4、gulp案例-图片和字体文件转换" class="headerlink" title="4、gulp案例-图片和字体文件转换"></a>4、gulp案例-图片和字体文件转换</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// gulpfile.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> parallel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-babel'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> swig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-swig'</span><span class="token punctuation">)</span>
<span class="token comment">// 执行`yarn add gulp-imagemin@7.1.0 --dev`安装gulp-imagemin(注意版本过高可能后续不能用)</span>
<span class="token comment">// 另外gulp-imagemin内部依赖的模块也是一些通过C++完成的模块，需要去GitHub上下载对应的二进制程序集</span>
<span class="token comment">// 又因国内对GitHub的访问不太友好，所以我们还需要用一些其他的办法解决。</span>
<span class="token keyword">const</span> imagemin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-imagemin'</span><span class="token punctuation">)</span>

<span class="token comment">// 样式编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/style/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 脚本编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 提供给模板使用的数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  menus<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
      icon<span class="token operator">:</span> <span class="token string">'aperture'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'index.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Features'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'features.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'about.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Contact'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'#'</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://dipcheese.com'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'divider'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://github.com/GeorgeSmith215'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  pkg<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  date<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 页面模板编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//导入gulp-imagemin模块后就可以pipe进去</span>
    <span class="token comment">//图片是无损压缩，只是删除了一些元数据信息，而对于svg这种，则是做了一些代码的格式化</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//字体文件中同样可能会出现svg，所以也可以用imagemin去处理，对于不能处理的文件也会照原样输出</span>
<span class="token keyword">const</span> <span class="token function-variable function">font</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 通过parallel组合任务使各种任务可以同时执行</span>
<span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">,</span> image<span class="token punctuation">,</span> font<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    compile<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="5、gulp案例-其他文件及文件清除"><a href="#5、gulp案例-其他文件及文件清除" class="headerlink" title="5、gulp案例-其他文件及文件清除"></a>5、gulp案例-其他文件及文件清除</h3><p>我们已经处理完成了所有的src目录下的文件，接下来我们还需要对public目录下的所有文件做一个拷贝。并在之后添加文件清除与构建（build）任务。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// gulpfile.js</span>
<span class="token comment">// 因为文件清除不能和其他任务同时执行，所以需要导入series</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> series <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-babel'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> swig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-swig'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> imagemin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-imagemin'</span><span class="token punctuation">)</span>
<span class="token comment">// 先执行`yarn add del --dev`去添加一个del模块，注意他不是gulp模块，但能在gulp中导入使用</span>
<span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span>


<span class="token comment">// 样式编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/style/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 脚本编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 提供给模板使用的数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  menus<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
      icon<span class="token operator">:</span> <span class="token string">'aperture'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'index.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Features'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'features.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'about.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Contact'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'#'</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://dipcheese.com'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'divider'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://github.com/GeorgeSmith215'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  pkg<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  date<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 页面模板编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//图像与字体转换压缩</span>
<span class="token keyword">const</span> <span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">font</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span>routes<span class="token operator">:</span><span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 通过extra任务对public目录下的所有文件做一个拷贝</span>
<span class="token keyword">const</span> <span class="token function-variable function">extra</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'public/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'public'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">clean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// del方法返回一个promise，所以gulp在del完成后可以标记clean任务完成</span>
    <span class="token keyword">return</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 一般compile只是对src下的文件做一个转换，所以我们单独添加一个新的任务build</span>
<span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">,</span> image<span class="token punctuation">,</span> font<span class="token punctuation">)</span>

<span class="token comment">// build任务需要先清除dist目录，所以需要先执行clean然后再同时转换输出src与public下的文件</span>
<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    compile<span class="token punctuation">,</span>
    build<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="6、gulp案例-自动加载插件"><a href="#6、gulp案例-自动加载插件" class="headerlink" title="6、gulp案例-自动加载插件"></a>6、gulp案例-自动加载插件</h3><p>随着我们的构建任务越来越复杂，我们使用到的插件也会越来越多，如果都是用require来手动载入插件的话就不太利于后期回顾代码。不过我们可以通过一个叫gulp-load-plugins的插件解决，通过执行<code>yarn add gulp-load-plugins --dev</code>来把gulp-load-plugins安装到开发依赖。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// gulpfile.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> series <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span>
<span class="token comment">// 把gulp-load-plugins安装到开发依赖后进行导入,注意这里require导出的是一个方法</span>
<span class="token keyword">const</span> loadPlugins <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-load-plugins'</span><span class="token punctuation">)</span>

<span class="token comment">// 通过loadPlugins方法得到一个plugins对象，所有的插件会成为对象上的一个属性。</span>
<span class="token comment">// plugins对象的属性对应插件的命名方式是把原来的‘gulp-’去掉，并用驼峰命名法</span>
<span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token function">loadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 样式编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/style/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// sass需要指定解释器，不能直接使用插件</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 脚本编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 自动导入插件后使用插件</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 提供给模板使用的数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  menus<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
      icon<span class="token operator">:</span> <span class="token string">'aperture'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'index.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Features'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'features.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'about.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Contact'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'#'</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://dipcheese.com'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'divider'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://github.com/GeorgeSmith215'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  pkg<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  date<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 页面模板编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 自动导入插件后使用插件</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//图像与字体转换压缩</span>
<span class="token keyword">const</span> <span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 自动导入插件后使用插件</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">font</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 自动导入插件后使用插件</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 拷贝public目录下的文件及其子目录文件</span>
<span class="token keyword">const</span> <span class="token function-variable function">extra</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'public/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'public'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 清除dist目录</span>
<span class="token keyword">const</span> <span class="token function-variable function">clean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">,</span> image<span class="token punctuation">,</span> font<span class="token punctuation">)</span>

<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    compile<span class="token punctuation">,</span>
    build<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="7、gulp案例-开发服务器"><a href="#7、gulp案例-开发服务器" class="headerlink" title="7、gulp案例-开发服务器"></a>7、gulp案例-开发服务器</h3><p>除了对文件的构建操作外，还需要一个开发服务器用于在开发阶段调试我们的应用，并且我们也可以用gulp去启动并管理这个服务器。之后我们就可以在后续配合其他的构建任务实现在代码修改后自动去编译并刷新浏览器页面，从而大大提高我们在开发阶段的效率，减少我们在开发阶段的重复操作。</p>
<p>首先我们需要先执行<code>yarn add browser-sync --dev</code>安装一下browser-sync模块到开发依赖。这个模块可以提供一个开发服务器，相较于普通使用express创建的服务器来说，browser-sync有更加强大的功能，具体就是他支持代码更新过后自动热更新到浏览器中，让我们可以即时看到页面的最新效果。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// gulpfile.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> series <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> loadPlugins <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-load-plugins'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token function">loadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span>
<span class="token comment">// 由于browser-sync并不是gulp插件，只不过我们是用gulp去管理他而已(与上面的del类似)</span>
<span class="token comment">// 所以在安装后还需要单独去引入</span>
<span class="token keyword">const</span> browserSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'browser-sync'</span><span class="token punctuation">)</span>
<span class="token comment">// browser-sync模块提供了一个create方法用于去创建一个服务器</span>
<span class="token keyword">const</span> bs <span class="token operator">=</span> browserSync<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 样式编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/style/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 脚本编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 提供给模板使用的数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  menus<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
      icon<span class="token operator">:</span> <span class="token string">'aperture'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'index.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Features'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'features.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'about.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Contact'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'#'</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://dipcheese.com'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'divider'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://github.com/GeorgeSmith215'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  pkg<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  date<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 页面模板编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//图像与字体转换压缩</span>
<span class="token keyword">const</span> <span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">font</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 拷贝public目录下的文件及其子目录文件</span>
<span class="token keyword">const</span> <span class="token function-variable function">extra</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'public/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'public'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 清除dist目录</span>
<span class="token keyword">const</span> <span class="token function-variable function">clean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将开发服务器单独定义到一个任务中启动</span>
<span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在任务中用bs的init方法去初始化一下web服务器的相关配置，并按配置启动服务器</span>
    bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">//配置里最核心的就是server</span>
        server<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// server中需要指定一下web服务器的网站根目录，通过baseDir属性设置</span>
            <span class="token comment">// src中都是未经加工的代码，而加工后的结果会放在dist中，所以这里是dist目录</span>
            baseDir<span class="token operator">:</span> <span class="token string">'dist'</span><span class="token punctuation">,</span>
            <span class="token comment">// 再给browserSync加一个特殊的路由，使之对页面中出现的“node_module”等</span>
            <span class="token comment">// 都能定向到指定目录下。通过routes去配置,并且routes会优先于baseDir，</span>
            <span class="token comment">// 当请求发出后会先看routes下有没有对应配置，没有时再找baseDir下文件。</span>
            routes<span class="token operator">:</span> <span class="token punctuation">{</span>
            	<span class="token comment">// 键代表请求的前缀，值为相对项目路径下的查找名称</span>
                <span class="token string">'/node_modules'</span><span class="token operator">:</span> <span class="token string">'node_modules'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 另外在init方法里还可以指定一些其他的小选项。</span>
        <span class="token comment">// 如notify属性可以设置是否在页面右上方提示browser-sync的连接状态，</span>
        <span class="token comment">// 这个提示可能会影响到我们调试界面的样式这些，就可以关闭</span>
        notify<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token comment">// 通过port属性去设置web服务器启动端口(默认是3000)</span>
        port<span class="token operator">:</span> <span class="token number">8888</span><span class="token punctuation">,</span>
        <span class="token comment">// 通过open属性控制是否在browser-sync启动时自动打开浏览器</span>
        open<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token comment">// 通过files属性指定browser-sync的监听文件(通配符)，</span>
        <span class="token comment">// 当监听的文件发生改变后，就会自动更新浏览器</span>
        <span class="token comment">// 注意本节中只是监听dist目录下的变化，下节将介绍src目录下文件变化的操作。</span>
        files<span class="token operator">:</span> <span class="token string">'dist/**'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">,</span> image<span class="token punctuation">,</span> font<span class="token punctuation">)</span>

<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    compile<span class="token punctuation">,</span>
    build<span class="token punctuation">,</span>
    serve<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="8、gulp案例-监视变化以及构建优化"><a href="#8、gulp案例-监视变化以及构建优化" class="headerlink" title="8、gulp案例-监视变化以及构建优化"></a>8、gulp案例-监视变化以及构建优化</h3><p>有了开发服务器之后，我们接下来重点要考虑的就是如何在src下的源代码修改过后自动去编译。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 我们需要借助gulp提供的watch API，他会自动监视一个文件路径的通配符，</span>
<span class="token comment">// 然后根据文件的变化决定是否需要重新执行某个任务</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> series<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> loadPlugins <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-load-plugins'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token function">loadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> browserSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'browser-sync'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bs <span class="token operator">=</span> browserSync<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 样式编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/style/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 脚本编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 提供给模板使用的数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  menus<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
      icon<span class="token operator">:</span> <span class="token string">'aperture'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'index.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Features'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'features.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'about.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Contact'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'#'</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://dipcheese.com'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'divider'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://github.com/GeorgeSmith215'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  pkg<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  date<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 页面模板编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 注意因swig模板引擎有缓存的机制，可能会导致页面不会发生变化，</span>
    <span class="token comment">// 这时需要额外将swig选项中的cache设置为false</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token punctuation">,</span> defaults<span class="token operator">:</span> <span class="token punctuation">{</span> cache<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//图像与字体转换压缩</span>
<span class="token keyword">const</span> <span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">font</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 拷贝public目录下的文件及其子目录文件</span>
<span class="token keyword">const</span> <span class="token function-variable function">extra</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'public/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'public'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 清除dist目录</span>
<span class="token keyword">const</span> <span class="token function-variable function">clean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 开发服务器启动任务</span>
<span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在serve开始的时候用watch监视一些文件，watch的第一个参数是监视的文件路径通配符，</span>
    <span class="token comment">// 第二个参数是监视文件变化后执行的对应任务</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/styles/*.scss'</span><span class="token punctuation">,</span> style<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> script<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span>
    <span class="token comment">// 注意我们在开发阶段时其实并不需要压缩相关文件的体积与拷贝public目录下文件，</span>
    <span class="token comment">// 并且进行这些额外任务还会降低开发时构建的效率</span>
    <span class="token comment">// 所以我们一般采用另外一种方式，即修改下面的baseDir属性</span>
    <span class="token comment">//watch('src/assets/images/**', image)</span>
    <span class="token comment">//watch('src/assets/fonts/**', font)</span>
    <span class="token comment">//watch('public/**', extra)</span>

    <span class="token comment">// 虽然并不需要压缩相关文件，但在源文件变化时依然需要更新浏览器，重新发起对这些文件的请求</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span>
        <span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span>
        <span class="token string">'public/**'</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> bs<span class="token punctuation">.</span>reload<span class="token punctuation">)</span>

    bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        server<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// 设置baseDir为数组，请求的文件按照数组索引顺序去查找</span>
            <span class="token comment">// 当dist里找不到时，就会依次到src与public里寻找源文件</span>
            baseDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            routes<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string">'/node_modules'</span><span class="token operator">:</span> <span class="token string">'node_modules'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        notify<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        port<span class="token operator">:</span> <span class="token number">8888</span><span class="token punctuation">,</span>
        open<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        files<span class="token operator">:</span> <span class="token string">'dist/**'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// compile相当于每次构建前的子任务</span>
<span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">)</span>

<span class="token comment">// build任务专门用于上线前的构建，最大化性能</span>
<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> image<span class="token punctuation">,</span> font<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 再添加一个develop组合任务，用于开发时使用，最小化构建时间</span>
<span class="token keyword">const</span> develop <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> serve<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    compile<span class="token punctuation">,</span>
    build<span class="token punctuation">,</span>
    develop<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注意我们在平时还可能遇到一种情况，就是在bs.init中不使用files属性去监听文件变化从而更新浏览器而都是用bs.reload去更新浏览器。这个原理也很简单，因为每次文件的变化都可以在watch中监视到，虽然在watch中不能传多个任务，但我们还可以在任务的pipe中进行浏览器的更新操作。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 样式编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/style/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// reload执行完的结果不是文件读写流，而只是把内部文件流的信息推到浏览器</span>
    <span class="token comment">// 指定stream: true参数来以流的方式往浏览器推</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 脚本编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 页面模板编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token punctuation">,</span> defaults<span class="token operator">:</span> <span class="token punctuation">{</span> cache<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 之后在下面的bs.init中就不需要指定files属性了</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="9、gulp案例-useref文件应用处理"><a href="#9、gulp案例-useref文件应用处理" class="headerlink" title="9、gulp案例-useref文件应用处理"></a>9、gulp案例-useref文件应用处理</h3><p>到目前为止，实际上大部分的构建任务都已经完成了，这些任务基本上都已经完成了核心的工作，但对于dist下生成的文件还有一些小问题。在执行完<code>yarn gulp build</code>后，dist目录下就会按照最终上线的状态呈现所有生成的文件，而在这些文件中就会出现在“node_module”中的一些文件依赖。而这些文件并没有拷贝到dist目录，当我们将dist目录部署上线的话就会出现问题，会出现找不到这些文件的情况。而我们在开发阶段运行没有问题的原因则是因为我们在serve命令里做过路由的映射，但这并不能在线上的环境这样做，所以我们还要单独去处理这样的情况。</p>
<p>针对上述问题的处理方法其实有很多，有一种简单方法就是在HTML中先写入一个不存在的路径然后通过构建的方式把这些文件拷贝到对应的路径中去。这种方法虽然简单，但比较low，本节将为大家介绍一个更为常见与强大的方式，即借助useref插件，useref插件会自动去处理HTML中的构建注释：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!-- 构建注释的开始标签为build，结束标签为endbuild。 --&gt;</span>
<span class="token comment">&lt;!-- 在开始标签后标记引入的文件类型，最后再指定一个文件路径， --&gt;</span>
<span class="token comment">&lt;!-- useref会自动将开始标签与结束标签之间引入的文件都合并打包到当前指定的文件路径中 --&gt;</span>
<span class="token comment">&lt;!-- build:css assets/styles/vendor.css --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/node_modules/bootstrap/dist/css/bootstrap.css<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- endbuild --&gt;</span>

<span class="token comment">&lt;!-- build:css assets/styles/main.css --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>assets/styles/main.css<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- endbuild --&gt;</span>

<span class="token comment">&lt;!-- build:js assets/scripts/vendor.js --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scripts</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/node_modules/jquery/dist/jquery.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scripts</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scripts</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/node_modules/popper.js/dist/umd/popper.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scripts</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scripts</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/node_modules/bootstrap/dist/js/bootstrap.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scripts</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- endbuild --&gt;</span>

<span class="token comment">&lt;!-- build:js assets/scripts/main.js --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scripts</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>assets/scripts/main.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scripts</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- endbuild --&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在gulpfile.js中我们也要添加一个新任务，不过需要先执行<code>yarn add gulp-useref --dev</code>去安装useref插件到开发依赖中。注意，useref可以理解为引用关系。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> series<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> loadPlugins <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-load-plugins'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token function">loadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> browserSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'browser-sync'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bs <span class="token operator">=</span> browserSync<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 样式编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/style/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 脚本编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 提供给模板使用的数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  menus<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
      icon<span class="token operator">:</span> <span class="token string">'aperture'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'index.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Features'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'features.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'about.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Contact'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'#'</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://dipcheese.com'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'divider'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://github.com/GeorgeSmith215'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  pkg<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  date<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 页面模板编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token punctuation">,</span> defaults<span class="token operator">:</span> <span class="token punctuation">{</span> cache<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//图像与字体转换压缩</span>
<span class="token keyword">const</span> <span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">font</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 拷贝public目录下的文件及其子目录文件</span>
<span class="token keyword">const</span> <span class="token function-variable function">extra</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'public/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'public'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 清除dist目录</span>
<span class="token keyword">const</span> <span class="token function-variable function">clean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 开发服务器启动任务</span>
<span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/styles/*.scss'</span><span class="token punctuation">,</span> style<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> script<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span>
        <span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span>
        <span class="token string">'public/**'</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> bs<span class="token punctuation">.</span>reload<span class="token punctuation">)</span>

    bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        server<span class="token operator">:</span> <span class="token punctuation">{</span>
            baseDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            routes<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string">'/node_modules'</span><span class="token operator">:</span> <span class="token string">'node_modules'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> 
        notify<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        port<span class="token operator">:</span> <span class="token number">8888</span><span class="token punctuation">,</span>
        open<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token comment">//files: 'dist/**'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">useref</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在useref任务中也和普通的任务类似，不同的是在src中我们要找的是dist下的html，</span>
    <span class="token comment">// 因为在src下的html是模板，模板里做useref是没有意义的，只有当文件都生成后才有意义。</span>
    <span class="token comment">// 注意下面的base指定与否都是一样的，因都在dist目录下，但为了保持一致在此还是指定。</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'dist/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'dist'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// useref会被自动加载，然后再通过useref创建转换流转换构建注释，</span>
    <span class="token comment">// 其中还需要设置一个searchPath参数去指定由构建注释包裹的对应文件的寻找路径。</span>
    <span class="token comment">// 注意对于数组型的参数，一般会把使用概率更大的情况放前面</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">useref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> searchPath<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 最后pipe到dest写入流中，注意这里指定dist目录存在一定的不合理</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
<span class="token punctuation">}</span>

<span class="token comment">// compile相当于每次构建前的子任务</span>
<span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">)</span>

<span class="token comment">// build任务专门用于上线前的构建，最大化性能</span>
<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> image<span class="token punctuation">,</span> font<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// develop任务，用于开发时使用，最小化构建时间</span>
<span class="token keyword">const</span> develop <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> serve<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    compile<span class="token punctuation">,</span>
    build<span class="token punctuation">,</span>
    develop<span class="token punctuation">,</span>
    useref<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>回到命令行执行<code>yarn gulp useref</code>去运行useref任务，之后dist目录下的文件就会发生变化。</p>
<p>当然，因为useref在运行之后会自动修改html，并由html中依赖的文件创建了一些新的文件生成到dist中，这个过程会在读取流中创建一些新文件，而我们则可以对这些新文件做一些压缩之类的操作，具体内容还请看下回分解。</p>
<h3 id="10、gulp案例-文件压缩"><a href="#10、gulp案例-文件压缩" class="headerlink" title="10、gulp案例-文件压缩"></a>10、gulp案例-文件压缩</h3><p>useref可以自动帮我们把依赖的文件都合并生成到dist下，但我们还是需要对这些生成的文件做一个压缩。</p>
<p>而我们需要压缩的文件有三种：JS、CSS、HTML，对于这三种文件类型我们要分别去做不同的压缩工作。首先执行<code>yarn add gulp-htmlmin gulp-uglify gulp-clean-css --dev</code>去分别安装压缩html，js，css的插件到开发依赖。并且因为读取流中会出现三种文件，而我们得分别对这些类型的文件做不同的操作，所以我们还得去判断一下读取流中是什么文件，这可以通过gulp-if插件完成。我们可以执行<code>yarn add gulp-if --dev</code>去安装该插件到开发依赖，有了这些插件后我们就可以去完成相关的压缩任务了。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> series<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> loadPlugins <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-load-plugins'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token function">loadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> browserSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'browser-sync'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bs <span class="token operator">=</span> browserSync<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 样式编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/style/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 脚本编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 提供给模板使用的数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  menus<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
      icon<span class="token operator">:</span> <span class="token string">'aperture'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'index.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Features'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'features.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'about.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Contact'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'#'</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://dipcheese.com'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'divider'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://github.com/GeorgeSmith215'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  pkg<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  date<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 页面模板编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token punctuation">,</span> defaults<span class="token operator">:</span> <span class="token punctuation">{</span> cache<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//图像与字体转换压缩</span>
<span class="token keyword">const</span> <span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">font</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 拷贝public目录下的文件及其子目录文件</span>
<span class="token keyword">const</span> <span class="token function-variable function">extra</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'public/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'public'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 清除dist目录</span>
<span class="token keyword">const</span> <span class="token function-variable function">clean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 开发服务器启动任务</span>
<span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/styles/*.scss'</span><span class="token punctuation">,</span> style<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> script<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span>
        <span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span>
        <span class="token string">'public/**'</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> bs<span class="token punctuation">.</span>reload<span class="token punctuation">)</span>

    bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        server<span class="token operator">:</span> <span class="token punctuation">{</span>
            baseDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            routes<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string">'/node_modules'</span><span class="token operator">:</span> <span class="token string">'node_modules'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        notify<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        port<span class="token operator">:</span> <span class="token number">8888</span><span class="token punctuation">,</span>
        open<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token comment">//files: 'dist/**'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">useref</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'dist/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'dist'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">useref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> searchPath<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// if会自动创建一个转换流，不过在转换流的内部会根据if指定的条件去决定是否去执行具体的转换流。</span>
    <span class="token comment">// if的第一个参数指定一个正则，自动匹配文件读取流中的文件路径</span>
    <span class="token comment">// if的第二个参数指定需要具体去工作的转换流</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">cleanCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 注意htmlmin默认只会压缩属性中的空白字符，而对于换行符这些都不会压缩，</span>
    <span class="token comment">// 所以我们需要额外去指定选项。</span>
    <span class="token comment">// 其中用collapseWhitespace: true指定压缩html中的空白字符和换行符，</span>
    <span class="token comment">// 设置minifyCSS和minifyJS为true指定压缩html内部的CSS和JS脚本。</span>
    <span class="token comment">// 另外htmlmin还有其他参数如移除注释，删除空属性等，可以参看官方文档(见本节末)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.html$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">htmlmin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        collapseWhitespace<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        minifyCSS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        minifyJS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 注意如果我们的读取流和写入流都在dist中就可能会出现文件读写冲突，</span>
    <span class="token comment">// 从而产生文件写不进去的情况。这时我们可以换一个目录写入最终的转换结果</span>
    <span class="token comment">//.pipe(dest('dist'))</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'release'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
<span class="token punctuation">}</span>

<span class="token comment">// compile相当于每次构建前的子任务</span>
<span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">)</span>

<span class="token comment">// build任务专门用于上线前的构建，最大化性能</span>
<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> image<span class="token punctuation">,</span> font<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// develop任务，用于开发时使用，最小化构建时间</span>
<span class="token keyword">const</span> develop <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> serve<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    compile<span class="token punctuation">,</span>
    build<span class="token punctuation">,</span>
    develop<span class="token punctuation">,</span>
    useref<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>此时我们的useref已经完成了引用文件的合并与压缩并生成到新文件中了，但现在的构建结构好像就被打破了。而下回我们就来分解如何重新去规划构建过程。</p>
<p>另附htmlmin官方文档：<a target="_blank" rel="noopener" href="https://github.com/kangax/html-minifier">传送门</a></p>
<h3 id="11、gulp案例-重新规划构建过程"><a href="#11、gulp案例-重新规划构建过程" class="headerlink" title="11、gulp案例-重新规划构建过程"></a>11、gulp案例-重新规划构建过程</h3><p>上节说到，useref打破了我们构建的目录结构。我们之前曾约定在开发阶段写的代码放在src目录下，而在编译完要打包上线的结果则放在dist目录下。但之前我们往dist目录中读文件并写入dist中时产生了文件冲突，所以我们又不得已把文件放在另一个目录。而这时我们真正上线的则应该是release目录下的文件，但release中又没有图片和字体文件，所以我们的目录结构就被打破了，我们需要重新去规整一下。</p>
<p>回顾代码，我们发现其实在useref之前我们一些生成的文件应该算是一个中间产物，即原来我们编译src下的文件生成到dist下后又去通过useref进行转换，这之间的文件其实算是中间文件。而我们如果把这些中间文件都放到临时的目录中，在useref时通过临时目录把这些文件拿出来做一些转换操作最后再放到dist里则会更合适一些。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> series<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> loadPlugins <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-load-plugins'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token function">loadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> browserSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'browser-sync'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bs <span class="token operator">=</span> browserSync<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 样式编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/style/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// style任务执行后还需要useref去合并、压缩相关的引用文件，所以需要转换后放到temp目录下</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'temp'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 脚本编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 和style类似，需要转换后放到temp目录下</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'temp'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 提供给模板使用的数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  menus<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
      icon<span class="token operator">:</span> <span class="token string">'aperture'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'index.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Features'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'features.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'about.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Contact'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'#'</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://dipcheese.com'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'divider'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://github.com/GeorgeSmith215'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  pkg<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  date<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 页面模板编译</span>
<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token punctuation">,</span> defaults<span class="token operator">:</span> <span class="token punctuation">{</span> cache<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 和style类似，需要转换后放到temp目录下</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'temp'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//图像与字体转换压缩</span>
<span class="token keyword">const</span> <span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// image任务并不需要用到useref而只在build时做相关转换所以可以不用放到temp下</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">font</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 和image任务类似，不需要放到temp下</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 拷贝public目录下的文件及其子目录文件</span>
<span class="token keyword">const</span> <span class="token function-variable function">extra</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'public/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'public'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 和image任务类似，不需要放到temp下</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 清除dist目录</span>
<span class="token keyword">const</span> <span class="token function-variable function">clean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在clean任务中可以加一个temp目录去清空中间文件所在目录</span>
    <span class="token keyword">return</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'temp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 开发服务器启动任务</span>
<span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/styles/*.scss'</span><span class="token punctuation">,</span> style<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> script<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span>
        <span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span>
        <span class="token string">'public/**'</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> bs<span class="token punctuation">.</span>reload<span class="token punctuation">)</span>

    bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        server<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// 因为在style，script，html任务(compile)执行后生成的文件都在temp下，</span>
            <span class="token comment">// 所以在baseDir中就应该去temp中找对应的文件了，</span>
            <span class="token comment">// 而dist目录只是我们最终需要上线打包的目录</span>
            baseDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'temp'</span><span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            routes<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string">'/node_modules'</span><span class="token operator">:</span> <span class="token string">'node_modules'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        notify<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        port<span class="token operator">:</span> <span class="token number">8888</span><span class="token punctuation">,</span>
        <span class="token comment">//open: false,</span>
        <span class="token comment">//files: 'dist/**'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">useref</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在useref中我们需要从temp中去取文件，并把最终的结果放到dist里</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'temp/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'temp'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">useref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> searchPath<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'temp'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">cleanCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.html$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">htmlmin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        collapseWhitespace<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        minifyCSS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        minifyJS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
<span class="token punctuation">}</span>

<span class="token comment">// compile相当于每次构建前的子任务</span>
<span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">)</span>

<span class="token comment">// build任务专门用于上线前的构建，最大化性能</span>
<span class="token comment">// 最后useref还应该放到我们的组合任务中去使用，注意useref必须要放在compile之后，</span>
<span class="token comment">// 所以compile和useref应该是一个串行的结构</span>
<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span><span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> useref<span class="token punctuation">)</span><span class="token punctuation">,</span> image<span class="token punctuation">,</span> font<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// develop任务，用于开发时使用，最小化构建时间</span>
<span class="token comment">// 注意develop和dist没有关系，他只是生成temp下的临时文件并通过serve找temp下的文件</span>
<span class="token keyword">const</span> develop <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> serve<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    compile<span class="token punctuation">,</span>
    build<span class="token punctuation">,</span>
    develop<span class="token punctuation">,</span>
    useref<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以上，我们完整的构建过程就已经告一段落了，当然在上面使用到的插件可能还会有额外的选项，我们在持续学习这部分内容的时候可以单独针对不同的插件去参考他们的官方文档，而上文中只是用到了最为常用的开发选项。</p>
<h3 id="12、gulp案例-补充"><a href="#12、gulp案例-补充" class="headerlink" title="12、gulp案例-补充"></a>12、gulp案例-补充</h3><p>在了解了完整的构建过程后，其实还留下了两个小问题，第一个问题就是对于我们的构建任务完成之后，如果不想配文档和说明的话，最好需要去调整一下我们导出的任务。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 其实我们只需要导出clean，build，develop任务就够了。</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    clean<span class="token punctuation">,</span>
    build<span class="token punctuation">,</span>
    develop<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>同时，我们还可以把这三个任务都放在package.json中，定义到scripts里，这样可以更容易让别人更理解一点。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"clean"</span><span class="token operator">:</span> <span class="token string">"gulp clean"</span><span class="token punctuation">,</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"gulp build"</span><span class="token punctuation">,</span>
    <span class="token property">"develop"</span><span class="token operator">:</span> <span class="token string">"gulp develop"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>另外我们还需要注意的就是，我们在npm的scripts中会自动找所执行的命令在node_modules下的可执行的命令文件，所以我们不需要通过<code>yarn</code>或<code>npm run</code>的方式去启动这些命令。之后我们想要启动相关的命令就可以直接使用<code>yarn &lt;相关命令&gt;</code>即可，可以更加方便些。</p>
<p>此外我们还需要注意的一个小点就是在.gitignore中去忽略一下生成的目录。</p>
<pre class="line-numbers language-.gitignore" data-language=".gitignore"><code class="language-.gitignore">dist
temp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>第二个问题是，我们在开发过程中创建的这种自动化工作流其实只要在相同类型的项目中都会重复被使用到，而我们应该如何去提取多个项目中共同的自动化过程？当然我们可以把这些代码放到代码段或笔记中记录下来，要用的时候再粘贴过去，这样虽然可以，但若要修改时就可能会非常麻烦，而之后的几节我们就会介绍如何去封装一个自己的工作流。</p>
<h3 id="13、封装工作流-准备"><a href="#13、封装工作流-准备" class="headerlink" title="13、封装工作流 - 准备"></a>13、封装工作流 - 准备</h3><p>接下来我们就来重点考虑一下在项目中gulpfile的复用问题。</p>
<p>如果我们要开发多个相同类型的项目，我们的自动化工作流其实应该是一样的，这时候就涉及到我们在多个项目中重复去使用这些构建任务。而这些构建任务在绝大多数情况下都是相同的，所以我们就面临一个需要去复用相同gulpfile的问题。对于这个问题我们当然可以用代码段的方式把这段代码保存起来，最后再copy到需要用到的地方，但这种方式会让我们的gulpfile散落在各个项目中，一旦当这个gulpfile有些问题需要我们去修复或者升级，就需要对每一个项目中的文件做相同的操作，十分不利于我们对整体的维护。所以我们要重点看如何去提取一个可复用的自动化构建工作流。</p>
<p>具体的解决方法也挺简单，就是通过创建一个新的模块去包装一下gulp，把自动化构建的工作流包装进去。因为gulp只是一个自动化构建工作流的一个平台，不负责帮我们提供任何的构建任务，我们的任何构建任务需要通过gulpfile去定义。而现在我们有了gulpfile也有了gulp，我们可以把他们通过一个模块结合在一起，之后我们就可以在以后的同类型项目中使用我们的模块去提供自动化构建的工作流就行了。</p>
<p>具体的做法就是我们先去创建一个模块，然后把这个模块发布到npm仓库上，最后在我们的项目中去使用即可。</p>
<p>首先，我们可以先到GitHub上创建一个仓库，这样我们就可以把我们新创建的模块托管到GitHub上，在新建时仓库的名字和模块的名字保持一致即可。创建完成后复制模块地址，回到命令行中，此时我们需要创建一个新的module。这里，我们当然可以使用传统的方式自己去初始化一个package.json这一系列文件，但我们之前已经接触过了脚手架，对于创建相同类型的项目，一般都可以使用脚手架来完成。经过之前的学习（<a href="">忘了的同学参看此处</a>），我们完全可以自己去实现一个脚手架，但在此，我们使用一个叫做caz的脚手架来完成创建module，通过执行<code>yarn global add caz</code>去全局安装caz模块。</p>
<p>在安装完caz后，可以通过执行<code>caz nm &lt;模块名&gt;</code>去创建一个node模块，他会和大多数的脚手架一样，先去GitHub上下载模板，之后询问一些问题，我们可以根据情况填写，需要注意的是，对于features我们全部不选，后续我们需要什么特性的时候可以自己去加，熟悉一步步建立的过程。之后caz会自动帮我们创建好项目，我们进入创建的目录，执行<code>git init</code>去初始化一下仓库。初始化完成后，执行<code>git remote add origin &lt;之前复制的模块仓库地址&gt;</code>为远程地址添加别名，之后执行<code>git add.</code>去添加文件到暂存区，接着执行<code>git commit -m "init"</code>去提交暂存区的文件到本地仓库，最后执行<code>git push -u origin master</code>以流的方式把本地仓库的文件推到origin别名的远程地址的master分支。回到GitHub中，刷新一下，就会发现所有的文件都已经更新了。</p>
<p>接下来看一看node module的大概结构，这个结构也即脚手架提供的默认约定。项目根目录下的文件主要就是特定工具的配置文件，而lib目录下的index.js则是项目的入口文件，后续需要在模块里实现的代码都放到这里。其实这些都是一个约定，也就是caz帮我们生成的node module提供的约定，我们就按照这个约定去创建之前所说的模块，把之前创建的自动化工作流的实现结合gulp形成新的模块，之后在我们后续使用同类型的项目时就可以使用该模块去提高效率。</p>
<h3 id="14、封装工作流-提取gulpfile"><a href="#14、封装工作流-提取gulpfile" class="headerlink" title="14、封装工作流 - 提取gulpfile"></a>14、封装工作流 - 提取gulpfile</h3><p>在上节中我们用脚手架创建了一个新的node模块，而接下来就将介绍如何实现具体的模块功能。</p>
<p>我们大致需要做的事情就是把之前创建的自动化构建的工作流提取到node模块中，然后在node模块中封装好工作流，接着再把一系列需要解决的问题都解决掉，最后我们就可以在多个项目中使用这个工作流了。</p>
<p>首先，我们知道要在node模块中包装gulp和gulpfile里提供的工作流的任务定制，而我们第一件要做的事情就是把gulpfile.js里的内容整体复制到node模块下lib目录下的index.js入口文件。模块的入口文件有了之后，里面还有不同的构建任务，而这些任务又是依赖一些模块的，所以我们还需要把这些模块作为我们的node模块的依赖去安装，这样后续我们在别的项目中使用到这个模块时，他就会自动去安装要用的模块。所以我们需要把我们之前工作流项目的package.json中的devDependencies的内容都复制到node模块的package.json中的dependencies里。注意因为每个工作流项目都不同所以不需要复制工作流中的dependencies，而至于为什么是复制到node模块的dependencies里是因为当我们去安装这个node模块时，会去安装该node模块的dependencies里的模块，而不是devDependencies，devDependencies开发依赖只是我们开发这个node模块所需要的东西，最终工作环节里只会有dependencies里的模块。</p>
<p>在将对应的dependencies复制到node模块中后，先执行<code>yarn</code>去安装一下复制过去的依赖模块，安装完成之后，node模块的基本工作就完成了。只不过对于node模块的入口文件，还有很多需要修改的地方。</p>
<p>以上就完成了该node模块第一步的工作，之后，我们回到原始的工作流项目中，把gulpfile.js里的内容以及相关的开发依赖devDependencies与工作流项目中的相关node_modules文件夹都删除掉（node_modules文件夹若在VSCode运行时删除不了的话可以先退出VSCode后再删除），用我们新的node模块去提供自动化构建的工作流。</p>
<p>在执行完清空后，若想用我们新的node模块去提供自动化构建的工作流，一般流程下我们需要先把这个node模块发布到npm仓库中，然后回到项目里安装这个模块，但现在是开发阶段，我们的模块还没开发完成，需要本地去调试。所以最简单的一种方式就是使用<code>yarn link</code>的方式把这个node模块link到当前工作流项目的node_modules中。首先，我们需要在node模块中打开命令行终端，执行<code>yarn link</code>去link一下我们的node模块，yarn会自动把我们的模块link到全局。之后我们就可以在任何一个项目中再通过<code>yarn link &lt;模块名&gt;</code>去把这个node模块link到该项目中。我们再到工作流项目的命令行窗口，执行<code>yarn link "&lt;我们的node模块名&gt;"</code>后就能发现在工作流项目下就有了node_modules文件夹，并在里面可以找到以我们的node模块名命名的文件夹，也可以看到在文件夹旁有一个标志着软链接的小图标。link了我们的node模块后，我们就可以在我们原本的工作流项目中使用这个模块了。注意我们的node模块导出的是gulpfile里的内容，而我们的工作流项目中缺的也正是相关的gulpfile，所以一拍即合，我们就可以在gulpfile.js直接写：<code>module.exports = require('&lt;我们的node模块名&gt;')</code>去把我们从node模块里读取的内容直接进行导出。</p>
<p>这时我们的gulpfile按理来讲就应该ok了，但因为之前我们删除了所有node_modules里的内容，所以这里还需要执行一下<code>yarn</code>去安装工作流相关的dependencies。安装完依赖之后，因为gulpfile实际上已经提供了从node模块中导入的任务，所以按道理来讲这个工作流项目是可以正常运行的。回到工作流的命令行中执行<code>yarn build</code>去运行导入的任务，可是运行之后会报一个错误，提示我们没有找到gulp命令。这个错误表示node在执行script时，没有办法找到script中使用的gulp命令，因为在使用yarn时会自动找项目目录下的node_modules目录下的bin文件夹下有没有yarn这个可执行文件，而现在其实并没有这个文件，所以gulp就使用不了。这里我们先使用一个比较low的办法，执行<code>yarn add gulp-cli --dev</code>把gulp的命令行可执行文件先安装到开发依赖，之后我们再考虑怎么去掉这个步骤。之后我们刷新一下项目目录，就会发现在node_modules目录的.bin文件夹下就有了相关的命令了。</p>
<p>现在，我们有了gulp命令，有了gulpfile，而且gulpfile里的内容是通过我们的node模块提供的，所以我们再执行一下<code>yarn build</code>应该就没问题了，结果命令行还是会报错提示找不到gulp，没办法，我们也只好先执行<code>yarn add gulp --dev</code>去安装一下gulp到开发依赖中。但其实这个问题在后续我们真正将模块发布出去之后就不存在了，因为当我们发布我们的这个node模块之后，当想安装该模块时，就会自动安装gulp模块，我们这里只是因为我们还没有完成才需要用这种方式先解决一下。最后，让我们再次执行<code>yarn build</code>去运行build任务，这时命令行中则会报一个找不到’./package.json’的错误，如果我们还有点印象的话，应该能想起来在我们之前的gulpfile中曾经定义了一个data数据变量，并在data中将模块的一些信息包裹进去（其中就包括了引用了package.json），最后在模板编译的时候使用了这些数据信息。但现在我们已经将gulpfile提取出来了，那data里面的相关require也就不存在了，另外，其实data是我们的项目才知道的，对于我们封装的通用模块是不应该知道的，如果有多个项目都使用了我们的通用模块，他们的data也应该是不一样的。这时我们可以用一种约定大于配置的方式去解决，即在我们的项目中抽象一个配置文件，然后在我们的node模块中读取一下相关的配置文件。这种方式是合理的，而至于如何去操作，还请看下回分解。</p>
<h3 id="15、封装工作流-解决模块中的问题"><a href="#15、封装工作流-解决模块中的问题" class="headerlink" title="15、封装工作流 - 解决模块中的问题"></a>15、封装工作流 - 解决模块中的问题</h3><p>上节讲到，我们想在我们的项目中抽象一个配置文件，然后在我们的node模块中读取一下相关的配置文件。现在我们需要做的事情就是把我们node模块中不应该被提取的东西全部都给抽出来。其中第一个就是我们上节讲到的data，这个data就可以通过约定大于配置的方式，在项目根目录下创建一个配置文件，然后在我们的node模块中尝试读取这个配置文件。而这个配置文件则可以有一个名字的约定，比如在这里我们就使用<code>pages.config.js</code>，这个其实也在很多常见成熟的自动化工作流或库中有所体现，比如vue-cli在工作时就会读取项目根目录下的vue.config.js，本质上都是一样的。</p>
<p>这时我们约定了有一个pages.config.js，我们就可以在这个文件中抽象一下那些不应该在公共模块中出现的内容。首先第一个需要导出的就是一个数据成员data，也即我们原本项目中的data。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// pages.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  data<span class="token operator">:</span> <span class="token punctuation">{</span>
    menus<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
        icon<span class="token operator">:</span> <span class="token string">'aperture'</span><span class="token punctuation">,</span>
        link<span class="token operator">:</span> <span class="token string">'index.html'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'Features'</span><span class="token punctuation">,</span>
        link<span class="token operator">:</span> <span class="token string">'features.html'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
        link<span class="token operator">:</span> <span class="token string">'about.html'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'Contact'</span><span class="token punctuation">,</span>
        link<span class="token operator">:</span> <span class="token string">'#'</span><span class="token punctuation">,</span>
        children<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
            link<span class="token operator">:</span> <span class="token string">'https://dipcheese.com'</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token string">'divider'</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
            link<span class="token operator">:</span> <span class="token string">'https://github.com/GeorgeSmith215'</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    pkg<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    date<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这时pages.config.js是在我们当前导入node模块的项目文件夹下，他自然可以找到当前目录下的package.json文件。我们把data放到pages.config.js中也不仅仅是为了可以运行，这也更符合逻辑，因为data本应属于实际要用到node模块的项目，而不应该在node公共模块自身中。</p>
<p>之后我们再回到node项目中，这时node模块就会缺少一个data，而这个data就需要我们动态require一下使用我们node模块项目下的pages.config.js了。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// lib/index.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> series<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> loadPlugins <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-load-plugins'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token function">loadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> browserSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'browser-sync'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bs <span class="token operator">=</span> browserSync<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 动态require一下使用我们node模块项目下的pages.config.js</span>
<span class="token comment">// process.cwd()会返回当前命令行所在的工作目录，而工作目录下就应有pages.config.js文件</span>
<span class="token keyword">const</span> cwd <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 用let是因为可能工作目录中没有相关配置文件，但也不能报错，所以应该要有一些默认配置</span>
<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里可以写一些默认配置</span>
<span class="token punctuation">}</span>

<span class="token comment">// 因为require一个不存在的地址会报错，所以这里用try...catch去包装一下</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里最好的方式是用path.join去连接路径，不过现在为了方便就直接使用模板字符串了</span>
    config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cwd<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/pages.config.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token comment">// 用Object.assign去合并两个对象，config在前，这样loadConfig就会覆盖config里的成员</span>
    config <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> config<span class="token punctuation">,</span> loadConfig<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">//catch并不需要去处理，因为如果读取失败了其实也有默认配置</span>

<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/style/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'temp'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 注意还需要修改presets的配置。presets最简单的方式是传一个字符串，</span>
    <span class="token comment">// babel工作时会自动去node_modules里找，还有一种方式就是直接载入一个presets对象，</span>
    <span class="token comment">// 这时我们就可以通过require的方式去载入。用require去载入模块会先到当前文件所在目录找，</span>
    <span class="token comment">// 之后依次往上找，直到项目根目录下有node_modules，其下就有@babel/preset-env</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'temp'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span><span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 在读取了配置文件后，就可以把data换成config.data</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> config<span class="token punctuation">.</span>data<span class="token punctuation">,</span> defaults<span class="token operator">:</span> <span class="token punctuation">{</span> cache<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'temp'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">font</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">extra</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'public/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'public'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">clean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'temp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/styles/*.scss'</span><span class="token punctuation">,</span> style<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> script<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span>
        <span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span>
        <span class="token string">'public/**'</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> bs<span class="token punctuation">.</span>reload<span class="token punctuation">)</span>

    bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        server<span class="token operator">:</span> <span class="token punctuation">{</span>
            baseDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'temp'</span><span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            routes<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string">'/node_modules'</span><span class="token operator">:</span> <span class="token string">'node_modules'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        notify<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        port<span class="token operator">:</span> <span class="token number">8888</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">useref</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'temp/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'temp'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">useref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> searchPath<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'temp'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">cleanCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.html$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">htmlmin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        collapseWhitespace<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        minifyCSS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        minifyJS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
<span class="token punctuation">}</span>

<span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">)</span>
<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span><span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> useref<span class="token punctuation">)</span><span class="token punctuation">,</span> image<span class="token punctuation">,</span> font<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> develop <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> serve<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    compile<span class="token punctuation">,</span>
    build<span class="token punctuation">,</span>
    develop<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>完成相关配置之后，执行<code>yarn build</code>就可以运行相关的build任务了。另外注意在build任务运行时会有build显示，但中间的组合任务名都会被省略，因为gulp是根据我们的gulpfile去推断我们的任务名字，而我们是把这些任务都包装进我们的node模块中，对于gulpfile就不知道相关的任务名，他唯一清楚的任务名就是我们启动的任务名。如果我们想要显示具体的组合任务的话，可以在gulpfile中解构对应的任务在进行组合导出，这样gulpfile就可以推断出这些任务名了，但对于我们这里并没有什么太大的意义，这里就不做具体的演示了。</p>
<h3 id="16、封装工作流-抽象路径配置"><a href="#16、封装工作流-抽象路径配置" class="headerlink" title="16、封装工作流 - 抽象路径配置"></a>16、封装工作流 - 抽象路径配置</h3><p>以上，我们的自动化构建工作流的node模块就算大致完成了，但这里其实还有一些地方可以做深度的包装。具体而言就是我们在代码里写死的路径，这些路径在我们使用的项目中其实可以看做是一种约定，约定固然好，但有时提供可以配置的能力也非常重要。因为在我们的项目中，如果我们要求项目的源代码目录不叫src目录的话，这时就可以通过配置的方式去覆盖，提供更灵活的配置。接下来我们就看一下怎样把灵活的配置抽象出来。</p>
<p>其实我们要做的也就是将index.js中写死的src，temp这些路径全部抽象出来形成配置，然后在刚刚约定的配置文件里去覆盖。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// lib/index.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> series<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> loadPlugins <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-load-plugins'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token function">loadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> browserSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'browser-sync'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bs <span class="token operator">=</span> browserSync<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> cwd <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里可以先加一些默认的配置，然后后续再通过pages.config.js去覆盖</span>
    build<span class="token operator">:</span> <span class="token punctuation">{</span>
    src<span class="token operator">:</span> <span class="token string">'src'</span><span class="token punctuation">,</span>
    dist<span class="token operator">:</span> <span class="token string">'dist'</span><span class="token punctuation">,</span>
    temp<span class="token operator">:</span> <span class="token string">'temp'</span><span class="token punctuation">,</span>
    <span class="token keyword">public</span><span class="token operator">:</span> <span class="token string">'public'</span><span class="token punctuation">,</span>
    <span class="token comment">// 有了基础路径后还需要把文件所在路径也提取出来以便后续灵活去配置</span>
    paths<span class="token operator">:</span> <span class="token punctuation">{</span>
      styles<span class="token operator">:</span> <span class="token string">'assets/styles/*.scss'</span><span class="token punctuation">,</span>
      scripts<span class="token operator">:</span> <span class="token string">'assets/scripts/*.js'</span><span class="token punctuation">,</span>
      pages<span class="token operator">:</span> <span class="token string">'*.html'</span><span class="token punctuation">,</span>
      images<span class="token operator">:</span> <span class="token string">'assets/images/**'</span><span class="token punctuation">,</span>
      fonts<span class="token operator">:</span> <span class="token string">'assets/fonts/**'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cwd<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/pages.config.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    config <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> config<span class="token punctuation">,</span> loadConfig<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 可以在src方法的选项中添加cwd选项，指定寻找相关文件的路径（默认为当前项目所在目录）</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>styles<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src<span class="token punctuation">,</span> cwd<span class="token operator">:</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>temp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 可以在src方法的选项中添加cwd选项，指定寻找相关文件的路径（默认为当前项目所在目录）</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>scripts<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src<span class="token punctuation">,</span> cwd<span class="token operator">:</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>temp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 可以在src方法的选项中添加cwd选项，指定寻找相关文件的路径（默认为当前项目所在目录）</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>pages<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src<span class="token punctuation">,</span> cwd<span class="token operator">:</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> config<span class="token punctuation">.</span>data<span class="token punctuation">,</span> defaults<span class="token operator">:</span> <span class="token punctuation">{</span> cache<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>temp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 可以在src方法的选项中添加cwd选项，指定寻找相关文件的路径（默认为当前项目所在目录）</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>images<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src<span class="token punctuation">,</span> cwd<span class="token operator">:</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>dist<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">font</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 可以在src方法的选项中添加cwd选项，指定寻找相关文件的路径（默认为当前项目所在目录）</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>fonts<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src<span class="token punctuation">,</span> cwd<span class="token operator">:</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>dist<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">extra</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对于public可以直接去通配一下所有文件即可</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>public<span class="token punctuation">,</span> cwd<span class="token operator">:</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>public  <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>dist<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">clean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>dist<span class="token punctuation">,</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>temp<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在watch中也可以通过第二参数去传cwd进去</span>
    <span class="token function">watch</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>styles<span class="token punctuation">,</span> <span class="token punctuation">{</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">,</span> style<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>scripts<span class="token punctuation">,</span> <span class="token punctuation">{</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">,</span> script<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>pages<span class="token punctuation">,</span> <span class="token punctuation">{</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>images<span class="token punctuation">,</span>
        config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>fonts
    <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">,</span> bs<span class="token punctuation">.</span>reload<span class="token punctuation">)</span>
    
    <span class="token comment">// 对于public的cwd目录是不一样的，所以需要单独抽出来一个watch</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>public <span class="token punctuation">}</span><span class="token punctuation">,</span> bs<span class="token punctuation">.</span>reload<span class="token punctuation">)</span>

    bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        server<span class="token operator">:</span> <span class="token punctuation">{</span>
            baseDir<span class="token operator">:</span> <span class="token punctuation">[</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>temp<span class="token punctuation">,</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>dist<span class="token punctuation">,</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>public<span class="token punctuation">]</span><span class="token punctuation">,</span>
            routes<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string">'/node_modules'</span><span class="token operator">:</span> <span class="token string">'node_modules'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        notify<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        port<span class="token operator">:</span> <span class="token number">8888</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">useref</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>pages<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>temp<span class="token punctuation">,</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>temp <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// '.'目录因为是项目根目录，肯定不会变，所以不需要修改</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">useref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> searchPath<span class="token operator">:</span> <span class="token punctuation">[</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>temp<span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">cleanCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.html$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">htmlmin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        collapseWhitespace<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        minifyCSS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        minifyJS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>dist<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
<span class="token punctuation">}</span>

<span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">)</span>
<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span><span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> useref<span class="token punctuation">)</span><span class="token punctuation">,</span> image<span class="token punctuation">,</span> font<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> develop <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> serve<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    compile<span class="token punctuation">,</span>
    build<span class="token punctuation">,</span>
    develop<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在抽象出来默认配置后，我们还可以尝试在项目的配置文件中也添加一个配置选项，去覆盖任意默认的路径。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// pages.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  build<span class="token operator">:</span> <span class="token punctuation">{</span>
    src<span class="token operator">:</span> <span class="token string">'src'</span><span class="token punctuation">,</span>
    dist<span class="token operator">:</span> <span class="token string">'dist'</span><span class="token punctuation">,</span>
    <span class="token comment">// 一些项目的临时文件可以放在'.'开头的目录下，因为在mac中'.'开头的目录默认都是隐藏目录，</span>
    <span class="token comment">// 像这些临时文件一般都不需要开发者去管理</span>
    temp<span class="token operator">:</span> <span class="token string">'.tmp'</span><span class="token punctuation">,</span>
    <span class="token keyword">public</span><span class="token operator">:</span> <span class="token string">'release'</span><span class="token punctuation">,</span>
    <span class="token comment">// 有了基础路径后还需要把文件所在路径也提取出来以便后续灵活去配置</span>
    paths<span class="token operator">:</span> <span class="token punctuation">{</span>
      styles<span class="token operator">:</span> <span class="token string">'assets/styles/*.scss'</span><span class="token punctuation">,</span>
      scripts<span class="token operator">:</span> <span class="token string">'assets/scripts/*.js'</span><span class="token punctuation">,</span>
      pages<span class="token operator">:</span> <span class="token string">'*.html'</span><span class="token punctuation">,</span>
      images<span class="token operator">:</span> <span class="token string">'assets/images/**'</span><span class="token punctuation">,</span>
      fonts<span class="token operator">:</span> <span class="token string">'assets/fonts/**'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> <span class="token punctuation">{</span>
    menus<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
        icon<span class="token operator">:</span> <span class="token string">'aperture'</span><span class="token punctuation">,</span>
        link<span class="token operator">:</span> <span class="token string">'index.html'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'Features'</span><span class="token punctuation">,</span>
        link<span class="token operator">:</span> <span class="token string">'features.html'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
        link<span class="token operator">:</span> <span class="token string">'about.html'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'Contact'</span><span class="token punctuation">,</span>
        link<span class="token operator">:</span> <span class="token string">'#'</span><span class="token punctuation">,</span>
        children<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
            link<span class="token operator">:</span> <span class="token string">'https://dipcheese.com'</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token string">'divider'</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
            link<span class="token operator">:</span> <span class="token string">'https://github.com/GeorgeSmith215'</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    pkg<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    date<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>之后我们再去执行<code>yarn build</code>以及<code>yarn develop</code>就能按照配置正常运行相关的任务了。</p>
<p>现在，对于我们的模块，其中完全抽象出来的东西都已经完成了。</p>
<p>在补充句题外话，其实对于开发者来讲，一开始可能还需要一些技能，之后还是需要我们有想法，想法建立在技能之上，当技能能满足我们的想法的时候，这时我们的想法越多越好，想法越多，尝试就会越多，获得的东西也会越多。</p>
<h3 id="17、封装工作流-包装Gulp-CLI"><a href="#17、封装工作流-包装Gulp-CLI" class="headerlink" title="17、封装工作流 - 包装Gulp CLI"></a>17、封装工作流 - 包装Gulp CLI</h3><p>至此，我们的自动化构建工作流的node模块大致上就基本完成了，但我们还可以做一些更多的操作让我们在使用他时能更加方便些。回顾我们使用这个node项目的过程，我们需要先把他安装到我们的项目中，然后在我们的项目中添加配置文件，这个配置文件是必要的。而我们的项目目录下还需要一个gulpfile.js，去把我们在node模块中工作流相关的任务导出，才可以通过gulp去运行。不过其实这个gulpfile对于我们的项目来讲，存在的价值就是把我们node模块中提供的任务导出去，这个就显得有些冗余了，而我们就希望在项目根目录下没有这个gulpfile也能正常工作。</p>
<p>我们先去把gulpfile.js删除，这时再执行<code>yarn gulp</code>就会报错，提示我们没有找到gulpfile。不过其实gulp的cli提供了一个命令行参数–gulpfile，可以指定gulpfile的所在路径，而对应的gulpfile其实就是安装了我们node模块的项目的<code>./node_modules/&lt;我们的模块名&gt;/lib/index.js</code>（我们之前删除的gulpfile.js其实也只是导出了这里面的内容）。我们可以通过执行<code>yarn gulp build --gulpfile ./node_modules/&lt;我们的模块名&gt;/lib/index.js</code>去运行对应的build任务。但还存在一个小问题就是这时我们的工作目录也已经变到了lib目录下，因为我们的gulpfile在lib下，yarn就会认为我们的工作目录也在lib目录，这时就不会把我们项目的根目录作为当前的工作目录了。不过，gulp也提供了–cwd参数去指定我们的工作目录，我们可以执行<code>yarn gulp build --gulpfile ./node_modules/&lt;我们的模块名&gt;/lib/index.js --cwd .</code>去指定我们的gulpfile以及工作目录（<code>'.'就代表项目根目录</code>）。此时，我们的工作目录就是当前目录，我们就可以正常去使用这个工作流，只不过任务的执行需要传递参数就显得比较复杂了。不过，我们也自然而然的产生了一些想法，就是在我们的node模块中也提供一个cli，在这个cli中传递需要的参数，然后在内部调用gulp-cli提供的可执行程序，这样的话，我们在外界使用时就不用再使用gulp了，就相当于把gulp完全包装于我们的node模块中了。</p>
<p>我们先在我们的node模块下面添加一个cli程序，注意对于node模块而言，一般我们的项目模块代码会放在lib目录下，而对项目的cli代码则一般放在bin目录下，所以我们要先在node模块目录下新建一个bin目录。在bin目录下我们新建一个<code>&lt;我们的模块名&gt;.js</code>文件，这个文件将会作为cli的执行入口，且因他是cli的执行入口，所以在我们node项目的package.json文件中还需要额外添加一个字段<code>"bin": "bin/&lt;我们的模块名&gt;.js"</code>去将我们的模块名作为cli命令。另外，其实我们还可以自定义cli命令，如在package.json中添加：<code>"bin": {"czs": "&lt;我们的模块名&gt;.js"}</code>，之后我们cli命令名就是czs了，不过这样容易产生冲突，故这里还是使用模块名字保险些。</p>
<p>编辑完package.json之后，我们在bin目录下的<code>&lt;我们的模块名&gt;.js</code>文件就会作为我们cli的入口。注意cli入口还需要有一个声明式注释<code>#!/usr/bin/env node</code>，并且在mac下还需要将文件的读写权限修改为755。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token hashbang comment">#!/usr/bin/env node</span>

<span class="token comment">// ./bin/&lt;我们的模块名&gt;.js中</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello node'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们先用上面的代码去简单使用一下我们的cli。首先我们要进入我们node模块的所在目录，执行<code>yarn unlike</code></p>
<p>先去取消之前的link，之后再执行<code>yarn link</code>去重新对我们的模块进行link，注册全局。link完我们的node模块后，我们就可以在命令行中执行<code>&lt;我们的模块名&gt;</code>去运行我们的cli了。而我们只需要把对gulp-cli的调用以及之前传的复杂参数都放在当前的cli入口文件中就行了。</p>
<p>我们先来看下gulp的cli是怎么工作的，可以在我们node模块的node_modules/.bin目录下找到一个gulp.cmd文件，在这个cmd文件中就是按照cmd语法写的一段代码。虽然我们可能不会写，但看懂他应该没什么大问题：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// '%~dp0'表示的是当前cmd所在的目录，也就是.bin目录</span>
<span class="token comment">// 刚开始的if语句就用来判断当前目录下有没有node.exe文件，有的话执行if后的语句，反之执行else后的语句</span>
@<span class="token constant">IF</span> <span class="token constant">EXIST</span> <span class="token string">"%~dp0\node.exe"</span> <span class="token punctuation">(</span>
  <span class="token string">"%~dp0\node.exe"</span>  <span class="token string">"%~dp0\..\gulp\bin\gulp.js"</span> <span class="token operator">%</span><span class="token operator">*</span>
<span class="token punctuation">)</span> <span class="token constant">ELSE</span> <span class="token punctuation">(</span>
  <span class="token comment">// 下面两个操作实际上就是配置了环境变量，让我们的可执行文件加了.js扩展名</span>
  @<span class="token constant">SETLOCAL</span>
  @<span class="token constant">SET</span> <span class="token constant">PATHEXT</span><span class="token operator">=</span><span class="token operator">%</span><span class="token constant">PATHEXT</span><span class="token operator">:</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token constant">JS</span><span class="token punctuation">;</span><span class="token operator">=</span><span class="token punctuation">;</span><span class="token operator">%</span>
  <span class="token comment">// 下面一行是重点，就是用node去执行当前目录的上一目录的gulp\bin\gulp.js</span>
  node  <span class="token string">"%~dp0\..\gulp\bin\gulp.js"</span> <span class="token operator">%</span><span class="token operator">*</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>再让我们去看看这个”gulp\bin\gulp.js”里是什么内容。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token hashbang comment">#!/usr/bin/env node</span>

<span class="token comment">// 这里实际上只是require了一下gulp-cli里的方法然后调用</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-cli'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>根据上面的代码，如果我们想在我们的cli中执行gulp的话也很简单，只要require一下gulp\bin\gulp.js就可以了，但问题是我们要怎么传递参数去指定gulpfile路径以及cwd路径。这里，其实我们在命令行中传递的参数可以通过<code>process.argv</code>去拿到，<code>process.argv</code>是一个数组，我们就可以在代码运行之前先往process.argv中push我们要传递的参数。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token hashbang comment">#!/usr/bin/env node</span>

<span class="token comment">// 工作目录应该是当前命令行所在的目录</span>
process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'--cwd'</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'--gulpfile'</span><span class="token punctuation">)</span>
<span class="token comment">// gulpfile所在路径就是当前node项目下的lib目录下的index.js，</span>
<span class="token comment">// 对于我们现在的这个项目，可以直接传require.resolve('..')，</span>
<span class="token comment">// require是载入相关模块，而require.resolve是找到这个模块对应文件的绝对路径。</span>
<span class="token comment">// resolve会自动去找package.json中main字段里对应的文件，同样也是对应的index.js文件</span>
process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp/bin/gulp'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>之后我们进入到安装了我们node模块的项目中，在该目录下执行<code>&lt;我们的模块名&gt; build</code>就可以运行对应的build任务了，我们的cli会自动找到位于lib/index.js的gulpfile，且gulp的工作目录也是当前目录。</p>
<p>完成了包装gulp cli后，我们的模块就不再要求我们的项目根目录下必须要有package.json，而且如果说我们把我们的node模块作为全局模块去安装的话，我们甚至在项目本地都不需要去安装依赖，这样也会让我们在后续的使用更加方便。相当于我们把gulp完全集成到我们的node模块中，就不需要再去安装gulp，gulp-cli这些模块，我们已经把这些都全包装到我们的node模块中了。</p>
<h3 id="18、封装工作流-发布并使用模块"><a href="#18、封装工作流-发布并使用模块" class="headerlink" title="18、封装工作流 - 发布并使用模块"></a>18、封装工作流 - 发布并使用模块</h3><p>在完成了我们的模块后，接下来我们就把这个模块发布到npm的仓库中，然后再到一个新的项目中去使用一下我们模块提供的cli以及相关的工作流。不过在我们发布之前，可能还需要做一个小小的改动，因为我们的node模块中还存在一个小小的问题，我们在通过npm去publish的时候，会默认把项目根目录下的文件和我们在package.json中的files属性中配置的对应目录发布到npm的仓库中。而我们现在的files中只有一个lib，所以我们还需要增加一个bin目录，之后npm再去发布的时候就会把bin目录，lib目录还有下面根目录的一些文件都发布出去。</p>
<p>在publish我们的模块之前，先用git对代码进行一个提交，执行<code>git add .</code>之后执行<code>git commit -m "feat: update package"</code>最后执行<code>git push</code>去把我们的代码push到仓库里。然后我们就可以publish我们的模块了，执行<code>yarn publish --registry https://registry.yarnpkg.com</code>去把我们的模块publish到yarn镜像源上，yarn镜像源和npm是保持同步的。publish之后，我们就可以在我们的新项目中使用这个模块了。</p>
<p>我们新建一个文件夹，然后把工作流项目的public，src目录都复制到这个文件夹中，另外也复制我们的模块配置文件pages.config.js文件。之后执行<code>yarn init --yes</code>去初始化一个package.json文件，然后再执行<code>yarn add &lt;我们的模块名&gt; --dev</code>去安装我们的模块到开发依赖中。这里补充一个可能会出现的小问题，就是我们在之前publish上去的是到官方的镜像中，而我们可能会使用淘宝的镜像源，这就可能导致在淘宝镜像源中的还是老版本或者根本找不到。这时我们就可以到淘宝镜像源的地址（<a target="_blank" rel="noopener" href="https://npm.taobao.org/">传送门</a>），搜索我们的模块名，在点击模块页中的SYNC去手动同步一下版本。</p>
<p>在安装完我们的模块之后，我们就可以在项目的node_modules下的.bin目录中找到我们的&lt;模块名&gt;.cmd文件，里面就是执行我们把gulp包装到内部的工具。回到项目中，我们就可以执行<code>yarn &lt;我们的模块名&gt; build</code>通过yarn去运行经我们模块包装过后的build任务。并且在我们项目的package.json中的scripts中也可以去更简单地定义相关的任务，关键是我们都不需要考虑gulp和gulp-cli的安装这些。</p>
<h3 id="19、FIS的基本使用"><a href="#19、FIS的基本使用" class="headerlink" title="19、FIS的基本使用"></a>19、FIS的基本使用</h3><p>FIS是百度的前端团队推出的一款构建系统，最早只在他们团队的内部使用，后来开源后在国内也流行过一段时间，但现在用的人越来越少，并且官方也已经很久没有更新版本了。但这些并不妨碍我们去了解他，因为fis完全属于另外一种类型的构建系统，相比于gulp和grunt，FIS的核心特点是高度集成，因为他把前端日常开发过程中的常见构建任务和调试任务都集成在了内部，开发者可以通过简单配置文件的方式去配置我们构建过程需要完成的工作。也就是说我们在FIS中不需要像gulp或grunt中一样，去定义一些任务，FIS中有一些内置的任务，这些内置的任务会根据开发者的配置自动完成整个构建的过程。除此之外，FIS中还内置了一款用于调试的webServer，可以很方便地调试我们的构建结果，而像这一系列的东西，在gulp或grunt中都是需要我们通过一些插件去实现的。接下来我们就一起简单了解一下FIS这款工具的基本使用。</p>
<p>首先，我们可以执行<code>yarn add fis3 --dev</code>去把一个叫fis3的模块安装在本地的开发依赖中，当然，我们也可以执行<code>yarn global add fis3</code>在全局范围安装这个模块，但这里还是建议安装在本地的开发依赖中，因为当我们的项目移植到别的机器上或别人开发时就可以更容易去了解我们使用的这些工具。至于为什么是fis3而不是fis，因为fis3相对于以前的版本做了很大的变化，所以单独为这个包起了一个新的名字fis3。安装完成之后我们就多出了一个fis3的命令。</p>
<p>通过执行<code>fis3 release -d output</code>可以将项目目录下的所有文件都编译到项目根目录下的output文件夹下，但fis在这个过程中并没有对sass以及ES6语法的js文件进行相关的转换，整个过程默认只会将代码中对于资源文件的相对路径引用自动转为绝对路径，实现资源的定位。资源定位其实是fis中的核心特性，他的作用就是将我们开发阶段的路径彻底与部署之间的关系分离开，我们只需要在开发阶段使用相对路径引入资源，fis构建完之后的结果会自动将这些资源文件的引用路径转换为绝对路径。</p>
<p>另外，我们可以为项目添加一个fis-conf.js文件，并在该文件中用fis.match方法为我们在构建过程中匹配到的文件添加一些指定的配置。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// fis-conf.js</span>
<span class="token comment">// 这里用fis.match匹配js、scss、png文件</span>
fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'*.{js,scss,png}'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将匹配到的文件的发布结果放到'assets/$0'下，$0表示当前文件原始的目录结构，</span>
    <span class="token comment">// 之后，我们输出的资源文件都会出现在assets这个目录下了</span>
    release<span class="token operator">:</span> <span class="token string">'assets/$0'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们通过fis资源定位的能力，就能大大提高我们代码的可移植性，因为不管我们部署在哪个后端项目中，只需要知道我们需要生成的结构是什么，然后我们根据生成的结构去配置我们的fis-conf.js就行了。</p>
<h3 id="20、FIS编译与压缩"><a href="#20、FIS编译与压缩" class="headerlink" title="20、FIS编译与压缩"></a>20、FIS编译与压缩</h3><p>除了资源定位外，fis当然还能做更多的事情，如果我们需要在构建的过程中对文件做编译的处理，同样需要通过配置文件的方式配置我们如何去处理文件的编译。比如我们尝试对项目中的sass文件做一些编译，就可以在配置文件中再添加一个配置。而对于整个配置文件的书写方式，fis官方的设计思路就是把他形成一种类似css的声明式的方式去做配置。具体的感觉就是我们通过fis.match方法的第一个参数去指定一个选择器，这个选择器选择到我们构建过程中那些文件，而后面的选项就是对于这些文件的配置。</p>
<p>如果我们想要对sass文件做一些单独配置的话也可以通过fis.match去选择sass文件。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// fis-conf.js</span>
<span class="token comment">// 这里用fis.match匹配js、scss、png文件</span>
fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'*.{js,scss,png}'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将匹配到的文件的发布结果放到'assets/$0'下，$0表示当前文件原始的目录结构，</span>
    <span class="token comment">// 之后，我们输出的资源文件都会出现在assets这个目录下了</span>
    release<span class="token operator">:</span> <span class="token string">'assets/$0'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 选择sass文件，'**/*.scss'表示任意目录下的sass文件</span>
fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'**/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用parser去指定对应的处理插件，这里还需要先执行`yarn add fis-parse-node-sass --dev`</span>
    <span class="token comment">// 去安装对应的插件（注意，如果fis是全局安装的话插件也需要全局安装）</span>
    <span class="token comment">// 通过fis.plugin方法去自动载入插件，注意插件的前缀是不需要的</span>
    parser<span class="token operator">:</span> fis<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'node-sass'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>保存之后再执行<code>fis3 release -d output</code>，fis会默认将生成的结果覆盖到output目录中，输出的sass文件中就会自动去转换sass语法，只不过扩展名没有修改，而至于扩展名的修改，我们可以在配置中再添加一个属性rExt。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// fis-conf.js</span>
fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'*.{js,scss,png}'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    release<span class="token operator">:</span> <span class="token string">'assets/$0'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'**/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// rExt可以记忆成rename Extension（修改扩展名），用rExt去指定修改的扩展名。</span>
    rExt<span class="token operator">:</span> <span class="token string">'.css'</span><span class="token punctuation">,</span>
    parser<span class="token operator">:</span> fis<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'node-sass'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>保存之后再执行<code>fis3 release -d output</code>，我们就会发现在输出的目录中就会有转换后的css文件了。而且，不光是帮我们把文件编译了，最终在我们使用这个文件的地方也会自动定位到我们编译后的结果资源，这也是fis资源定位核心能力的体现。对于sass的转换实际上添加这样一个配置就可以了，以此类推，如果我们想要转换es6代码的话，我们也可以借助这种方式去配置。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// fis-conf.js</span>
fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'*.{js,scss,png}'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    release<span class="token operator">:</span> <span class="token string">'assets/$0'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'**/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    rExt<span class="token operator">:</span> <span class="token string">'.css'</span><span class="token punctuation">,</span>
    parser<span class="token operator">:</span> fis<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'node-sass'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'**/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注意这里还是使用babel6.x，因为fis官方发布的插件还是基于babel6的版本，</span>
    <span class="token comment">// 这里需要先执行`yarn add fis-parser-babel-6.x --dev`去安装这个插件到开发依赖中。</span>
    parser<span class="token operator">:</span> fis<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'babel-6.x'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>保存之后再执行<code>fis3 release -d output</code>，我们就会发现在输出的output目录中就会有转换后的相关文件。除此之外如果我们还想要做一些压缩的操作的话也可以再去使用一些插件来做压缩。而对于压缩，我们要使用optimizer去指定另外的一些插件。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// fis-conf.js</span>
fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'*.{js,scss,png}'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    release<span class="token operator">:</span> <span class="token string">'assets/$0'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'**/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    rExt<span class="token operator">:</span> <span class="token string">'.css'</span><span class="token punctuation">,</span>
    parser<span class="token operator">:</span> fis<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'node-sass'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 压缩的插件其实是fis中内置的，可以直接使用</span>
    optimizer<span class="token operator">:</span> fis<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'clean-css'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

fis<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'**/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    parser<span class="token operator">:</span> fis<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'babel-6.x'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 压缩的插件其实是fis中内置的，可以直接使用</span>
    optimizer<span class="token operator">:</span> fis<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'uglify-js'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>保存之后再执行<code>fis3 release -d output</code>，我们就会发现在输出的output目录中就会有转换后的相关文件，并且也做了压缩操作。</p>
<p>以上就是我们针对fis中要想做一些编译和转换的使用方式，具体的操作一般就是通过配置文件中的声明就可以了。另外，我们可以在命令行中执行<code>fis3 inspect</code>去查看相关的转换过程，以便于调试我们的配置文件。</p>
<p>对于大家新开发的项目而言，还是建议大家使用gulp去构建，因为gulp的生态更完善，且他背后有专业的团队去维护，也就不会出现长时间不更新的问题。不过我们学习的目的也不是什么火我们学什么，我们决定学习更多是参考他能给我们带来多少思考与启发。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">智升</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://dipcheese.com/2022/06/12/feautomaticallybuilding2/">https://dipcheese.com/2022/06/12/feautomaticallybuilding2/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">智升</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/study/">
                                    <span class="chip bg-color">study</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: 'd5bf45b19fa279c7e54c',
        clientSecret: 'f6a4f9f107cd87350ea6ab378fb4721bdcd43879',
        repo: 'georgesmith215.github.io',
        owner: 'GeorgeSmith215',
        admin: ["GeorgeSmith215"],
        id: '2022-06-12T15-54-55',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2022/06/12/feautomaticallybuilding2/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="前端工程化之自动化构建">
                        
                        <span class="card-title">前端工程化之自动化构建</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-06-12
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AD%A6%E4%B9%A0/" class="post-category">
                                    学习
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/study/">
                        <span class="chip bg-color">study</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/05/18/feautomaticallybuilding/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="前端工程化之自动化构建--Grunt与Gulp的使用">
                        
                        <span class="card-title">前端工程化之自动化构建--Grunt与Gulp的使用</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-05-18
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AD%A6%E4%B9%A0/" class="post-category">
                                    学习
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/study/">
                        <span class="chip bg-color">study</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="6800773181"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy; 
            
                <span id="year">2021-2022</span>
            
            dipcheese. 版权所有
            <!-- <span id="year">2021</span> -->
            <a href="/about" target="_blank">智升</a>
            <!-- |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a> -->
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2021";
                        var startMonth = "7";
                        var startDate = "1";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/georgesmith215" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2089281458@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/profile.php?id=100023997492884" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook: https://www.facebook.com/profile.php?id=100023997492884" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>



    <a href="https://twitter.com/GeorgeSmith215" class="tooltipped" target="_blank" data-tooltip="关注我的Twitter: https://twitter.com/GeorgeSmith215" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2089281458" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2089281458" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://weibo.com/u/5766671582" class="tooltipped" target="_blank" data-tooltip="关注我的微博: https://weibo.com/u/5766671582" data-position="top" data-delay="50">
        <i class="fab fa-weibo"></i>
    </a>



    <a href="https://www.zhihu.com/people/chen-zhi-sheng-63" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/chen-zhi-sheng-63" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?17136257";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    
        <script src="//code.tidio.co/arjcrzt8ibgtjdhobc9yxyekjvtvc6jl.js"></script>
        <script>
            $(document).ready(function () {
                setInterval(change_Tidio, 50);
                function change_Tidio() {
                    var tidio=$("#tidio-chat iframe");
                    if(tidio.css("display")=="block"&& $(window).width()>977 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" &&$(window).width()>977)>0? "-40px" : ($("div.toc-title").length&&$(window).width()>977)>0?"85px":"20px";
                        document.getElementById("tidio-chat-iframe").style.right="-15px";
                        document.getElementById("tidio-chat-iframe").style.height=parseInt(tidio.css("height"))>=520?"520px":tidio.css("height");
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()>601 &&$(window).width()<992 ){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && 601< $(window).width()<992)>0? "-40px":"20px" ;
                        document.getElementById("tidio-chat-iframe").style.right="-15px";
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    else if(tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))<230){
                        document.getElementById("tidio-chat-iframe").style.bottom= ($("div#backTop.top-scroll").css("display")=="none" && $(window).width()<601)>0? "-10px":"45px" ;
                        document.getElementById("tidio-chat-iframe").style.zIndex="997";
                    }
                    if( tidio.css("display")=="block"&&$(window).width()<601 && parseInt(tidio.css("height"))>=230){
                        document.getElementById("tidio-chat-iframe").style.zIndex="998";
                    }
                }
            });
        </script>
    

    

    <!--腾讯兔小巢-->
    
        <div style="position:fixed;bottom:125px;right:16px;cursor: pointer;">
            <a title="兔小巢" target="_blank" rel="noopener" href="https://support.qq.com/products/347029"><i class="fa fa-comments fa-3x"  aria-hidden="true"></i></a>
        </div>
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300,"hOffset":-15,"vOffset":-15},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>

</html>
